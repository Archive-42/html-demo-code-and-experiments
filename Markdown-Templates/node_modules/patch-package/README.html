<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<p align="center">
<img src="https://ds300.github.io/patch-package/patch-package.svg" width="80%" alt="patch-package" />
</p>
<p><code>patch-package</code> lets app authors instantly make and keep fixes to npm dependencies. It’s a vital band-aid for those of us living on the bleeding edge.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># fix a bug in one of your dependencies</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ex">vim</span> node_modules/some-package/brokenFile.js</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co"># run patch-package to create a .patch file</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ex">npx</span> patch-package some-package</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co"># commit the patch file to share the fix with your team</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="fu">git</span> add patches/some-package+3.14.15.patch</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="fu">git</span> commit -m <span class="st">&quot;fix brokenFile.js in some-package&quot;</span></a></code></pre></div>
<p>Patches created by <code>patch-package</code> are automatically and gracefully applied when you use <code>npm</code>(&gt;=5) or <code>yarn</code>.</p>
<p>No more waiting around for pull requests to be merged and published. No more forking repos just to fix that one tiny thing preventing your app from working.</p>
<h2 id="set-up">Set-up</h2>
<p>In package.json</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb2-1" title="1"> &quot;scripts&quot;: {</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="va">+  &quot;postinstall&quot;: &quot;patch-package&quot;</span></a>
<a class="sourceLine" id="cb2-3" title="3"> }</a></code></pre></div>
<p>Then</p>
<h3 id="npm">npm</h3>
<pre><code>npm i patch-package</code></pre>
<p>You can use <code>--save-dev</code> if you don’t need to run npm in production, e.g. if you’re making a web frontend.</p>
<h3 id="yarn">yarn</h3>
<pre><code>yarn add patch-package postinstall-postinstall</code></pre>
<p>You can use <code>--dev</code> if you don’t need to run yarn in production, e.g. if you’re making a web frontend.</p>
<p>To understand why yarn needs the <code>postinstall-postinstall</code> package see: <a href="#why-use-postinstall-postinstall-with-yarn">Why use postinstall-postinstall</a></p>
<h3 id="yarn-workspaces">yarn workspaces</h3>
<p>Same as for yarn ☝️ Note that if you want to patch un-hoisted packages you’ll need to repeat the setup process for the child package. Also make sure you’re in the child package directory when you run <code>patch-package</code> to generate the patch files.</p>
<h3 id="heroku">Heroku</h3>
<p>For <code>patch-package</code> to work on Heroku applications, you must specify <a href="https://devcenter.heroku.com/articles/nodejs-support#package-installation"><code>NPM_CONFIG_PRODUCTION=false</code> or <code>YARN_PRODUCTION=false</code></a>. See <a href="https://github.com/ds300/patch-package/issues/130">this issue</a> for more details.</p>
<h3 id="docker-and-ci">Docker and CI</h3>
<ul>
<li>If having errors about working directory (“cannot run in wd […]”) when building in Docker, you might need to adjust configuration in <code>.npmrc</code>. See <a href="https://github.com/ds300/patch-package/issues/185">#185</a>.</li>
<li>In your <code>Dockerfile</code>, remember to copy over the patch files <em>before</em> running <code>[npm|yarn] install</code></li>
<li><p>If you cache <code>node_modules</code> rather than running <code>yarn install</code> every time, make sure that the <code>patches</code> dir is included in your cache key somehow. Otherwise if you update a patch then the change may not be reflected on subsequent CI runs.</p>
<p>E.g., for CircleCI: before loading/saving your cache run <code>cat patches/* | md5 &gt; patches.hash</code> and then update your hash key to include a checksum of that file, <code>{{ checksum "yarn.lock" }}-{{ checksum "patches.hash" }}</code>.</p></li>
</ul>
<h2 id="usage">Usage</h2>
<h3 id="making-patches">Making patches</h3>
<p>First make changes to the files of a particular package in your node_modules folder, then run</p>
<pre><code>yarn patch-package package-name</code></pre>
<p>or use npx (included with <code>npm &gt; 5.2</code>)</p>
<pre><code>npx patch-package package-name</code></pre>
<p>where <code>package-name</code> matches the name of the package you made changes to.</p>
<p>If this is the first time you’ve used <code>patch-package</code>, it will create a folder called <code>patches</code> in the root dir of your app. Inside will be a file called <code>package-name+0.44.0.patch</code> or something, which is a diff between normal old <code>package-name</code> and your fixed version. Commit this to share the fix with your team.</p>
<h4 id="options">Options</h4>
<ul>
<li><p><code>--create-issue</code></p>
<p>For packages whose source is hosted on GitHub this option opens a web browser with a draft issue based on your diff.</p></li>
<li><p><code>--use-yarn</code></p>
<p>By default, patch-package checks whether you use npm or yarn based on which lockfile you have. If you have both, it uses npm by default. Set this option to override that default and always use yarn.</p></li>
<li><p><code>--exclude &lt;regexp&gt;</code></p>
<p>Ignore paths matching the regexp when creating patch files. Paths are relative to the root dir of the package to be patched.</p>
<p>Default value: <code>package\\.json$</code></p></li>
<li><p><code>--include &lt;regexp&gt;</code></p>
<p>Only consider paths matching the regexp when creating patch files. Paths are relative to the root dir of the package to be patched.</p>
<p>Default value: <code>.*</code></p></li>
<li><p><code>--case-sensitive-path-filtering</code></p>
<p>Make regexps used in –include or –exclude filters case-sensitive.</p></li>
<li><p><code>--patch-dir</code></p>
<p>Specify the name for the directory in which to put the patch files.</p></li>
</ul>
<h4 id="nested-packages">Nested packages</h4>
<p>If you are trying to patch a package at, e.g. <code>node_modules/package/node_modules/another-package</code> you can just put a <code>/</code> between the package names:</p>
<pre><code>npx patch-package package/another-package</code></pre>
<p>It works with scoped packages too</p>
<pre><code>npx patch-package @my/package/@my/other-package</code></pre>
<h3 id="updating-patches">Updating patches</h3>
<p>Use exactly the same process as for making patches in the first place, i.e. make more changes, run patch-package, commit the changes to the patch file.</p>
<h3 id="applying-patches">Applying patches</h3>
<p>Run <code>patch-package</code> without arguments to apply all patches in your project.</p>
<h4 id="options-1">Options</h4>
<ul>
<li><p><code>--error-on-fail</code></p>
<p>Forces patch-package to exit with code 1 after failing.</p>
<p>When running locally patch-package always exits with 0 by default. This happens even after failing to apply patches because otherwise yarn.lock and package.json might get out of sync with node_modules, which can be very confusing.</p>
<p><code>--error-on-fail</code> is <strong>switched on</strong> by default on CI.</p>
<p>See https://github.com/ds300/patch-package/issues/86 for background.</p></li>
<li><p><code>--reverse</code></p>
<p>Un-applies all patches.</p>
<p>Note that this will fail if the patched files have changed since being patched. In that case, you’ll probably need to re-install <code>node_modules</code>.</p>
<p>This option was added to help people using CircleCI avoid <a href="https://github.com/ds300/patch-package/issues/37">an issue around caching and patch file updates</a> but might be useful in other contexts too.</p></li>
<li><p><code>--patch-dir</code></p>
<p>Specify the name for the directory in which the patch files are located</p></li>
</ul>
<h4 id="notes">Notes</h4>
<p>To apply patches individually, you may use <code>git</code>:</p>
<pre><code>git apply --ignore-whitespace patches/package-name+0.44.2.patch</code></pre>
<p>or <code>patch</code> in unixy environments:</p>
<pre><code>patch -p1 -i patches/package-name+0.44.2.patch</code></pre>
<h3 id="dev-only-patches">Dev-only patches</h3>
<p>If you deploy your package to production (e.g. your package is a server) then any patched <code>devDependencies</code> will not be present when patch-package runs in production. It will happily ignore those patch files if the package to be patched is listed directly in the <code>devDependencies</code> of your package.json. If it’s a transitive dependency patch-package can’t detect that it is safe to ignore and will throw an error. To fix this, mark patches for transitive dev dependencies as dev-only by renaming from, e.g.</p>
<pre><code>package-name+0.44.0.patch</code></pre>
<p>to</p>
<pre><code>package-name+0.44.0.dev.patch</code></pre>
<p>This will allow those patch files to be safely ignored when <code>NODE_ENV=production</code>.</p>
<h2 id="benefits-of-patching-over-forking">Benefits of patching over forking</h2>
<ul>
<li>Sometimes forks need extra build steps, e.g. with react-native for Android. Forget that noise.</li>
<li>Get told in big red letters when the dependency changed and you need to check that your fix is still valid.</li>
<li>Keep your patches colocated with the code that depends on them.</li>
<li>Patches can be reviewed as part of your normal review process, forks probably can’t</li>
</ul>
<h2 id="when-to-fork-instead">When to fork instead</h2>
<ul>
<li>The change is too consequential to be developed in situ.</li>
<li>The change would be useful to other people as-is.</li>
<li>You can afford to make a proper PR to upstream.</li>
</ul>
<h2 id="isnt-this-dangerous">Isn’t this dangerous?</h2>
<p>Nope. The technique is quite robust. Here are some things to keep in mind though:</p>
<ul>
<li>It’s easy to forget to run <code>yarn</code> or <code>npm</code> when switching between branches that do and don’t have patch files.</li>
<li>Long lived patches can be costly to maintain if they affect an area of code that is updated regularly and you want to update the package regularly too.</li>
<li>Big semantic changes can be hard to review. Keep them small and obvious or add plenty of comments.</li>
<li>Changes can also impact the behaviour of other untouched packages. It’s normally obvious when this will happen, and often desired, but be careful nonetheless.</li>
</ul>
<h2 id="why-use-postinstall-postinstall-with-yarn">Why use postinstall-postinstall with Yarn?</h2>
<p>Most times when you do a <code>yarn</code>, <code>yarn add</code>, <code>yarn remove</code>, or <code>yarn install</code> (which is the same as just <code>yarn</code>) Yarn will completely replace the contents of your node_modules with freshly unpackaged modules. patch-package uses the <code>postinstall</code> hook to modify these fresh modules, so that they behave well according to your will.</p>
<p>Yarn only runs the <code>postinstall</code> hook after <code>yarn</code> and <code>yarn add</code>, but not after <code>yarn remove</code>. The <code>postinstall-postinstall</code> package is used to make sure your <code>postinstall</code> hook gets executed even after a <code>yarn remove</code>.</p>
<h2 id="license">License</h2>
<p>MIT</p>
<p><a href="http://futurice.com/blog/sponsoring-free-time-open-source-activities?utm_source=github&amp;utm_medium=spice&amp;utm_campaign=patch-package"><img src="https://img.shields.io/badge/sponsor-chilicorn-ff69b4.svg" alt="Empowered by Futurice’s open source sponsorship program" /></a></p>
</body>
</html>
