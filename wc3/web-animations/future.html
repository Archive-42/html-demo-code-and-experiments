<!DOCTYPE html>
<!-- vim: set expandtab ts=2 sw=2 tw=80: -->
<html>
  <head>
    <title>Web Animations Future</title>
    <meta charset="utf-8">
    <script src="respec/respec.js" class="remove"></script>
    <script
      src="http://dev.w3.org/2009/dap/ReSpec.js/js/lang/sh_javascript.min.js"
      class="remove"></script>
    <script class="remove">
      var respecConfig = {
        // specification status (e.g. WD, LCWD, NOTE, etc.). If in doubt use
        // ED.
        specStatus: "unofficial",

        // the specification's short name, as in
        // http://www.w3.org/TR/short-name/
        // shortName:            "web-anim",

        // if your specification has a subtitle that goes below the main
        // formal title, define it here
        // subtitle   :  "an excellent document",

        // if you wish the publication date to be other than today, set this
        // publishDate:  "2009-08-06",

        // if the specification's copyright date is a range of years, specify
        // the start date here:
        // copyrightStart: "2012"

        // if there is a previously published draft, uncomment this and set
        // its YYYY-MM-DD date and its maturity status
        // previousPublishDate: "1977-03-15",
        // previousMaturity: "WD",

        // if there a publicly available Editor's Draft, this is the link
        // edDraftURI:
        // "https://dvcs.w3.org/hg/FXTF/raw-file/tip/web-anim/index.html",

        // if this is a LCWD, uncomment and set the end of its review period
        // lcEnd: "2009-08-05",

        // if you want to have extra CSS, append them to this list
        // it is recommended that the respec.css stylesheet be kept
        extraCSS: ["respec/respec.css",
                   "web-animations.css"],

        // Turning off inlineCSS for now since if extraCSS points to
        // a relative URL your testing from a file URL the XHR will fail.
        // Probably should turn this back on once this is hosted on a server
        // somewhere.
        inlineCSS: false,

        // editors, add as many as you like
        // only "name" is required
        editors:  [
          { name: "Web Animations editors" }
        ],

        // authors, add as many as you like.
        // This is optional, uncomment if you have authors as well as editors.
        // only "name" is required. Same format as editors.

        //authors:  [
        //    { name: "Your Name", url: "http://example.org/",
        //      company: "Your Company", companyURL: "http://example.com/" },
        //],

        // XXX If we continue using ReSpec then we need to tweak it to support
        // multiple working groups. It includes updating the patent section
        // prose to say "groups" instead of "group" etc.
        // name of the WG
        wg: "CSS Working Group (part of the Style Activity) and the SVG " +
            "Working Group (part of the Graphics Activity)",

        // URI of the public WG page
        // wgURI: "http://www.w3.org/Graphics/fx/",

        // name (without the @w3c.org) of the public mailing to which comments
        // are due
        wgPublicList: "public-fx",

        // URI of the patent status for this WG, for Rec-track documents
        // !!!! IMPORTANT !!!!
        // This is important for Rec-track documents, do not copy a patent URI
        // from a random document unless you know what you're doing. If in
        // doubt ask your friendly neighbourhood Team Contact.
        wgPatentURI:  "",

        noIDLSorting: true,
        noIDLIn: true
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      This is the abstract for your specification.
    </section>
    <section>
      <h2>The <code>Timeline</code> interface</h2>
      <dl title="partial interface Timeline" class="idl">
        <dt>double? fromTimelineTime (double timelineTime,
                                      TimedItem target)</dt>
        <dd>
          <p class="annotation">
            This is basically supposed to be a method that answers the question,
            "If the time of this timeline is A (<em>timelineTime</em>), what
            will the local time be at timed item B (<em>target</em>)?"
          </p>
          <p>
            Returns the corresponding time value for a given timed item,
            <em>target</em>, for a time value relative to this timeline
            using the following procedure.
          </p>
          <p class="todo">
            All the following needs to be updated since it refers to time
            sources etc.
          </p>
          <ol>
            <li>Define the <dfn>parent time source</dfn> of time source A as
                being the value of a <code>timeline</code> property on A if
                such a property exists and refers to a <a>TimeSource</a>
                object.</li>
            <li>Define an <dfn>ancestor time source</dfn> of time source A as
                any time source that appears in the chain of parent time
                sources constructed starting with the <a>parent time
                source</a> of A and continuing with each subsequent parent
                up to and including a document time source or until there are
                no further parent time sources.</li>
            <li>Define a time source A as being <dfn>derived from another time
                source</dfn> B if B is an <a>ancestor time source</a> of
                A.</li>
            <li>Determine <var>local document time</var> as follows:
              <dl class="switch">
                <dt>If <em>other</em> is not <a title="derived from another
                time source">derived from</a> this document time source,</dt>
                <dd>
                  <ol>
                    <li>
                      Let <var>remote document</var> be the document time
                      source that is an <a>ancestor time source</a> of
                      <em>other</em> if such a document time source exists.
                    </li>
                    <li>
                      If there is no such <var>remote document</var> raise
                      a <code>DOMException</code> of type
                      <code>HierarchyRequestError</code>.
                    </li>
                    <li>
                      Let <var>local document time</var> be the result of
                      calling <code>toDocumentTime(<em>documentTime</em>,
                      <var>remote document</var>)</code> on this object.
                    </li>
                  </ol>
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Let <var>local document time</var> be <em>documentTime</em>.
                </dd>
              </dl>
            </li>
            <li>
              Calculate the <code>currentTime</code> of <em>other</em> by
              following the steps described <span
              class="todo">somewhere...</span>
            </li>
          </ol>
          <p>
            Exceptions:
          </p>
          <dl class="exceptions">
            <dt>DOMException of type <code>HierarchyRequestError</code></dt>
            <dd>
              Raised if <em>other</em> does not have an <a>ancestor time
              source</a> that is a document time source object.
            </dd>
          </dl>
          <p class="issue">
            Is this needed? And is the automatic cross-document time source
            negotation required?
          </p>
        </dd>
      </dl>
    </section>
    <section>
      <h2>Scaling the time</h2>
      <section>
        <h3>The <code>TimingFunctionCallback</code> callback</h3>
        <p>
          In addition to the timing functions provided by Web Animations,
          authors may also provide their own time scaling function.
          The behavior of this function is defined by the
          <a>TimingFunctionCallback</a> type below.
        </p>
        <div title="callback TimingFunctionCallback = double ()" class="idl">
          <p>
            A <a>TimingFunctionCallback</a> function has the same behavior as
            defined for the <code>scaleTime</code> method on the
            <a>TimingFunction</a> interface.
            That is, it takes an input time fraction, applies some scaling
            operation to it, and returns an output time fraction.
          </p>
          <p>
            For the same input <code>time</code> and <code>item</code>, this
            function MUST return the same output.
          </p>
          <p>
            As a result, a user agent MAY cache the results returned by
            a <a>TimingFunctionCallback</a> as an optimization.
            Note, however, that if the <code>item</code> object is changed, this
            consitutes different input to the function and hence the user agent
            MUST NOT cache the results of the callback if the <code>item</code>
            object changes.
            Given the requirement that callback functions do not change
            <code>item</code>, a user agent can expect that it is safe to cache
            the output of a <a>TimingFunctionCallback</a> for at least the
            duration of a sample.
          </p>
          <div class="issue">
            <p>
              Is it important to be able to differentiate between when the
              scaling is being applied to an iteration as a whole or simply to
              a segment of a keyframe animation?
            </p>
            <p>
              I suspect it probably is and that that would consitute different
              input to the function.
            </p>
          </div>
          <dl class="parameters">
            <dt>double time</dt>
            <dd>
              The input time fraction in the range [0.0, 1.0].
            </dd>
            <dt>TimedItem? item</dt>
            <dd>
              The <a>TimedItem</a> for which the scaling is being performed.
              This object MUST NOT be modified.
            </dd>
          </dl>
        </div>
        <section>
          <h4>Applying time manipulations</h4>
          <p>Needs to be adjusted as follows:</p>
          <ol>
            <li>&hellip;</li>
            <li>
              Scale the time as follows:
              <dl class="switch">
                <dt>If <var>timing.timingFunction</var> is
                    a <a>TimingFunction</a> object,</dt>
                <dd>
                  <p>
                    Let <var>scaled iteration time</var> be
                    <code>unscaled iteration time *
                      timing.timingFunction.scaleTime(<var>unscaled iteration
                      time</var> / <a>iteration duration</a>)))</code>.
                  </p>
                </dd>
                <dt>If <var>timing.timingFunction</var> is
                    a <a>TimingFunctionCallback</a> function,</dt>
                <dd>
                  <p>
                    Let <var>scaled iteration time</var> be
                    <code>unscaled iteration time *
                      timing.timingFunction(<var>unscaled iteration
                      time</var> / <a>iteration duration</a>)))</code>.
                  </p>
                  <p>
                    If calling <code>timing.timingFunction</code>
                    results in an exception being thrown, let <var>scaled
                    iteration time</var> be <var>unscaled iteration time</var>.
                  </p>
                  <div class="todo">
                    <p>
                      Need to consider:
                    </p>
                    <ul>
                      <li>Is there any way to lock down the model during this
                          step? i.e. make everything read-only?
                          (Of course it's not fully possible, but can we do
                          enough that it's meaningful?)
                          Maybe implementations can just display something in
                          the console: "If you're changing stuff in a timing
                          function you're going to have a bad time"</li>
                      <li>Can we cache some values before calling to ensure that
                          at least this procedure will complete as
                          expected?</li>
                      <li>Need to define exactly when this procedure is
                          performed since both the timing and the number of
                          times it is called could produce different results if
                          the script has side effects.
                          For example, does querying
                          <code>TimedItem.iterationTime</code> result in the
                          script being executed every time?
                          <p>
                          Possibly could define things such that iteration time
                          is evaluated on each sample (need to define sampling)
                          and then only if <code>iterationTime</code> is
                          explicitly requested (i.e. no caching there)... what
                          about other operations that rely on iteration time
                          being up to date? what are they?
                          </p>
                      </li>
                      <li>At points where this is called we need to check the
                          state of the model after calling.</li>
                      <li>Do we need some disclaimer saying, "if the script has
                          side effects all bets are off"</li>
                      <li>Also need to be careful that the callback doesn't call
                          anything that triggers calculating the iteration time
                          (e.g. <code>TimedItem.iterationTime</code> should use
                          a cached value in that case)</li>
                      <li>I think script-defined timing functions might get
                          punted to v2</li>
                    </ul>
                  </div>
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Let <var>scaled iteration time</var> be <var>unscaled
                  iteration time</var>.
                </dd>
              </dl>
            </li>
            <li>&hellip;</li>
          </ol>
        </section>
      </section>
    </section>

    <section>
      <h2>Animation templates</h2>
      <div class="informative">
      <p>
        It is sometimes necessary to apply the same animation effect to a series
        of targets.
        Animation templates provide a means for the same set of animation
        properties to be applied repeatedly to a number of targets
        whilst maintaining a link such that changes to the template are
        reflected at each place where the template is applied.
      </p>
      <p>
        In concrete terms, an <a>AnimationTemplate</a> object is used to create
        multiple <a>Animation</a> objects each of which maintains a link back to
        the template via its <code>template</code> property.
        Such <a>Animation</a> objects are said to be <dfn>linked</dfn> to
        a template.
      </p>
      <p>
        The timing and animation parameters of <a>linked</a> animations cannot
        be modified directly.
        Rather, changes are made to the template which is then echoed to all
        animations linked to the same template.
        In order to modify the timing and animation parameters of
        a <a>linked</a> animation directly, it must first be unlinked using the
        <code>unlink</code> method.
      </p>
      <p>
        Note that run-time properties of a <a>linked</a> animation such as its
        <var>start time</var> and <var>time drift</var> can still be modified.
        Only those properties attached to the <code>timing</code> and
        <code>effect</code> properties of a <a>linked</a> <a>Animation</a>
        object are read-only.
      </p>
      <p>
        Unlinked animations can be linked to a template by:
      </p>
      <ul>
        <li>assigning the <var>template</var> property to an
        <a>AnimationTemplate</a> <span class="todo">(Is this right? Are we going
        to do this?)</span>, or</li>
        <li>calling <code>templatize</code> to create a new
        <a>AnimationTemplate</a> with properties set to reflect the current
        state of the <a>Animation</a> object on which it is called.</li>
      </ul>
      <p class="todo">
        Provide some javascript sample here demonstrating?
      </p>
      </div> <!-- informative -->
      <section>
        <h3><a>Animation</a> interface members</h3>
        <dl title="partial interface Animation" class="idl">
          <dt>attribute AnimationTemplate? template</dt>
          <dd>
            <p>
              For linked animations (see <a href="#animation-templates"
              class="sectionRef"></a>), the <a>AnimationTemplate</a> object
              from which this object derives its values.
              For animations that are not linked to a template, this property is
              <code>null</code>.
            </p>
            <p>
              Setting this property has the following effect:
            </p>
            <ol>
              <li>Let <var>new template</var> be the value to assign to the
                  <code>template</code> property.</li>
              <li>If <var>new template</var> is <code>null</code>,
                <ol>
                  <li>Call <code>unlink()</code>.</li>
                </ol>
              </li>
              <li>Otherwise,
                <ol>
                  <li>Set <code>timing</code> to <code><var>new
                      template</var>.timing.clone()</code>.</li>
                  <li>Set <code>effect</code> to <code><var>new
                      template</var>.effect.clone()</code>.</li>
                  <li>Set <code>template</code> to <code><var>new
                      template</var></code>.</li>
                </ol>
              </li>
            </ol>
          </dd>
          <dt>AnimationTemplate templatize()</dt>
          <dd>
            <p>
              If this object is not already linked to a template,
              creates a new <a>AnimationTemplate</a> object based on this object
              and links this object to it (see <a href="#animation-templates"
              class="sectionRef"></a>).
            </p>
            <p class="feedbackWanted">
              What is the more useful behavior? To always create a template?
              Or to only create one if it doesn't already have one?
            </p>
            <p>
              The effect is equivalent to the following steps:
            </p>
            <ol>
              <li>Let <var>source</var> be the object on which
                  <code>templatize</code> is called.</li>
              <li>If <code><var>source</var>.template</code> is not
                  <code>null</code>, return.</li>
              <li>Create a new <a>AnimationTemplate</a> object,
                  <var>template</var>.</li>
              <li>Set <code><var>template</var>.timing</code> to
                  <code><var>source</var>.timing.clone()</code>.</li>
              <li>Set <code><var>template</var>.effect</code> to
                  <code><var>source</var>.effect.clone()</code>.</li>
              <li>Set <code><var>source</var>.template</code> to
                  <var>template</var>.</li>
              <li>Return <var>template</var>.</li>
            </ol>
          </dd>
          <dt>AnimationTemplate? unlink()</dt>
          <dd>
            <p>
              Makes this animation independent of the template with which it is
              associated if any
              (see <a href="#animation-templates" class="sectionRef"></a>)
            </p>
            <p>
              After setting <code>template</code> to <code>null</code> the
              previous value of <code>template</code> is returned.
            </p>
            <p>
              The effect is equivalent to the following steps:
            </p>
            <ol>
              <li>If <code>template</code> is <code>null</code>, return
                  <code>null</code>.</li>
              <li>Let <var>old template</var> be <code>template</code>.</li>
              <li>Set <code>timing</code> to
                  <code>template.timing.clone()</code>.</li>
              <li>Set <code>effect</code> to
                  <code>template.effect.clone()</code>.</li>
              <li>Set <code>template</code> to <code>null</code> (but do not
                  recursively call this function).</li>
              <li>Return <var>old template</var>.</li>
            </ol>
          </dd>
        </dl>
        </dl>
      </section>
      <section>
        <h3>The <code>AnimationTemplate</code> interface</h3>
        <p>
          <dl title="[Constructor] interface AnimationTemplate : TimedTemplate"
            class="idl">
            <dt>attribute (AnimationEffect or CustomAnimationEffect)
              effect</dt> <dd>
              The animation effect to apply.
            </dd>
          </dl>
        </p>
      </section>
      <section>
        <h3>The <code>TimedTemplate</code> interface</h3>
        <p>
          Both the timing of an <code>AnimationTemplate</code> and the methods
          for creating an <code>Animation</code> from an
          <code>AnimationTemplate</code> are specified on the
          <code>TimedTemplate</code> since this behavior is shared with
          animation groups (see <a href="#group-templates"
          class="sectionRef"></a>).
        </p>
        <p class="todo">
          Should we allow live lists to be passed in? i.e. selectors etc.?
        </p>
        <dl title="interface TimedTemplate" class="idl">
          <dt>attribute Timing timing</dt>
          <dd>
            The timing parameters to use for generated timed items.
          </dd>
          <dt>TimedItem animate ()</dt>
          <dd>
            <p>
              Creates an independent <code>TimedItem</code> and appends it
              to <code>element.ownerDocument.animationTimeline</code>.
            </p>
            <p>
              This allows the following sort of usage:
            </p>
            <pre class="example sh_javascript">
              anim.animate(document.getElementById("a"));
            </pre>
            <p>
              The specific steps for instantiating a
              <code>TimedTemplate</code> depends on its concrete type and is
              described in <a href="#instantiating-an-animationtemplate"
              class="sectionRef"></a> and <a
              href="#instantiating-an-animationgrouptemplate"
              class="sectionRef"></a>.
            </p>
            <dl class="parameters">
              <dt>AnimationTarget target</dt>
              <dd>
                The element or pseudo-element to be targetted.
              </dd>
              <dt>optional double startTime</dt>
              <dd>
                <p>
                  The start time for the generated animations
                  expressed in seconds in the iteration time space of the
                  <code>AnimationGroup</code> to which it is
                  appended (see <a href="#time-spaces" class="sectionRef"></a>).
                </p>
                <p>
                  If this parameter is not specified it will default to the
                  current iteration time of the
                  <code>AnimationGroup</code> to which it is
                  appended if it is not <code>null</code>, otherwise it will
                  default to zero.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>sequence&lt;TimedItem&gt; animate ()</dt>
          <dd>
            <p>
              Creates a series of independent <code>TimedItem</code>
              objects, one for each element in <code>target</code>.
              As with <code>animate(AnimationTarget target, double
              startTime)</code> each such <code>TimedItem</code> object is
              appended to <code>element.ownerDocument.animationTimeline</code>.
            </p>
            <p>
              This allows the following sort of usage:
            </p>
            <pre class="example sh_javascript">
  anim.animate([document.getElementById("a"), document.getElementById("b")]);
  anim.animate(document.querySelectorAll("div.warning"));
  anim.animate(document.getElementsByTagName("button"));
  anim.animate(document.getElementById("group").childNodes);
            </pre>
            <p>
              The specific steps for instantiating a
              <code>TimedTemplate</code> depends on its concrete type and is
              described in <a href="#instantiating-an-animationtemplate"
              class="sectionRef"></a> and <a
              href="#instantiating-an-animationgrouptemplate"
              class="sectionRef"></a>.
            </p>
            <dl class="parameters">
              <dt>sequence&lt;Node&gt; targets</dt>
              <dd>
                An sequence of <code>Node</code>s to be animated.
                Any nodes in the sequence that are not of type
                <code>ELEMENT_NODE</code> will be ignored.
              </dd>
              <dt>optional double startTime</dt>
              <dd>
                As with <code>animate(AnimationTarget target, optional double
                  startTime)</code>.
              </dd>
            </dl>
          </dd>
          <dt>TimedItem animateWithParent ()</dt>
          <dd>
            <p>
              Similar to <code>animate</code>, this method creates
              independent <code>TimedItem</code> object(s) for the
              elements in <code>target</code>.
              However, the resulting items are appended to the given
              <code>parentGroup</code>, if provided.
              If <code>parentGroup</code> is <code>null</code>, the
              <code>TimedItem</code> objects will not be added to any
              group.
            </p>
            <dl class="parameters">
              <dt>AnimationTarget target</dt>
              <dd>
                As with <code>animate</code>.
              </dd>
              <dt>AnimationGroup? parentGroup</dt>
              <dd>
                The animation group to which animations should be appended.
              </dd>
              <dt>optional double startTime</dt>
              <dd>
                <p>
                  The start time for the generated animations
                  expressed in seconds in the iteration time space of the
                  <code>AnimationGroup</code> to which it is
                  appended (see <a href="#time-spaces" class="sectionRef"></a>).
                </p>
                <p>
                  If this parameter is not specified it will default to the
                  current iteration time of <code>parentGroup</code>.
                  If <code>parentGroup</code> is <code>null</code>,
                  this parameter will default to zero.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>sequence&lt;TimedItem&gt; animateWithParent (
            sequence&lt;Node&gt; targets,
            AnimationGroup? parentGroup,
            optional double startTime)</dt>
          <dd>
            As with <code>animateWithParent(AnimationTarget target,
              AnimationGroup? parentGroup,
              optional double startTime)</code> except
            one <code>TimedItem</code> is created for each
            <code>Node</code> in <code>target</code> that is of type
            <code>ELEMENT_NODE</code>.
          </dd>
          <dt>TimedItem animateLive (AnimationTarget target,
            optional double startTime)</dt>
          <dd>
            As with <code>animate</code> with the exception that the
            <code>TimedItem</code> objects generated by this method are
            live.
          </dd>
          <dt>sequence&lt;TimedItem&gt; animateLive (
            sequence&lt;Node&gt; targets, optional double startTime)</dt>
          <dd>
            As with <code>animate</code> with the exception that the
            <code>TimedItem</code> objects generated by this method are
            live.
          </dd>
          <dt>TimedItem animateLiveWithParent
            (AnimationTarget target, AnimationGroup? parentGroup,
             optional double startTime)</dt>
          <dd>
            As with <code>animateWithParent</code> with the exception that the
            animations generated by this method are live.
          </dd>
          <dt>sequence&lt;TimedItem&gt; animateLiveWithParent
            (sequence&lt;Node&gt; targets, AnimationGroup? parentGroup,
             optional double startTime)</dt>
          <dd>
            As with <code>animateWithParent</code> with the exception that the
            animations generated by this method are live.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Instantiating an <code>AnimationTemplate</code></h3>
        <p>
          The procedure for instantiating an <code>AnimationTemplate</code>,
          <var>template</var>, given a list of target elements and an optional
          <var>parent group</var>, is as follows:
        </p>
        <ol>
          <li>
            Create an empty sequence of <code>Animation</code> objects.
          </li>
          <li>
            For each <var>element</var> in the list of target elements:
            <ol>
              <li>
                Create a new <code>Animation</code> object, <var>anim</var>.
              </li>
              <li>
                Set the <code>timing</code> and <code>effect</code>
                properties of <var>anim</var> to copies
                <code>template.timing</code> and
                <code>template.effect</code>.
              </li>
              <li>
                If <var>parentGroup</var> is not specified, let
                <var>parentGroup</var> be
                <code><var>element</var>.ownerDocument.animationTimeline</code>.
              </li>
              <li>
                Append <var>element</var> to <var>parentGroup</var>.
              </li>
              <li>
                Append <var>element</var> to the sequence of
                <code>Animation</code> objects.
              </li>
            </ol>
          </li>
          <li>
            Return the sequence of <code>Animation</code> objects.
          </li>
        </ol>
      </section>
      <section>
        <h3>Group templates</h3>
        <p>
          As with animations, templates can also be created for animation
          groups.
        </p>
        <p class="todo">
          Lots of questions here about how this should work.
        </p>
      </section>
      <section>
        <h3>The <code>AnimationGroupTemplate</code> interface</h3>
        <p class="todo">
          TBD
        </p>
        <dl title="interface AnimationGroupTemplate : TimedTemplate"
          class="idl">
          <dt>void clear ()</dt>
          <dd>
            Removes all child items from the group.
          </dd>
          <dt>getter TimedTemplate? (unsigned long index)</dt>
          <dd>
            Returns the template item at <code>index</code>.
            If <code>index</code> is greater than or equal to
            <code>length</code> returns <code>null</code>.
          </dd>
          <dt>setter TimedTemplate (unsigned long index,
                                    TimedTemplate newItem)</dt>
          <dd>
            <p>
              Replaces the item at <code>index</code> with
              <code>newItem</code> by calling
              <code>splice(index, 1, newItem)</code>.
            </p>
            <p>
              Returns <code>newItem</code>.
            </p>
            <p>
              The behavior of this method is identical to
              the equivalent setter in <code>AnimationGroup</code>
              except that DOMExceptions of type HierarchyRequestError are not
              thrown.
            </p>
          </dd>
          <dt>sequence&lt;TimedTemplate&gt; add (
                TimedTemplate newItem, TimedTemplate... otherItems)</dt>
          <dd>
            <p>
              Add <code>newItem</code> and each <code>otherItems</code> as the
              last item(s) in the group by calling <code>splice(group.length, 0,
              newItem, otherItem1, ... otherItemN)</code>.
            </p>
            <p>
              Returns a sequence containing the added items:
              <code>[newItem, otherItem1, ... otherItemN]</code>.
            </p>
          </dd>
          <dt>sequence&lt;TimedTemplate&gt; remove (
                long index, optional unsigned long count = 1)</dt>
          <dd>
            <p>
              Removes the item(s) at <code>index</code> by calling
              <code>splice(index, count)</code>.
            </p>
            <p>
              Returns the removed items.
            </p>
          </dd>
          <dt>
            sequence&lt;TimedTemplate&gt; splice ()
          </dt>
          <dd>
            <p>
              Modifies the list of children of this group by first removing
              <code>deleteCount</code> items from <code>start</code> followed by
              adding <code>newItems</code> at the same point.
            </p>
            <p>
              Returns a sequence of the items removed from group during the
              removal step (regardless of whether these items were re-added
              during the addition step).
            </p>
            <p>
              As with <code>AnimationGroup.slice</code> the operation of
              slice is based on <a
              href="http://www.ecma-international.org/publications/files/ECMA-ST-ARCH/ECMA-262%205th%20edition%20December%202009.pdf#page=140">ECMAScript
              5's Array.prototype.splice</a>.
            </p>
            <p>
              The operation of this method is identical to that of
              <code>AnimationGroup.slice</code> with the notable difference
              that DOMExceptions of type HierarchyRequestError are not thrown
              since there is no <code>AnimationGroupTemplate</code>
              corresponding to a document timeline.
            </p>
            <dl class="parameters">
              <dt>long start</dt>
              <dd>
                The index at which items should be removed and inserted.
                Negative indices represent an offset from the end of the list of
                items.
                This value is clamped to the range [-<code>length</code>,
                <code>length</code>].
              </dd>
              <dt>unsigned long deleteCount</dt>
              <dd>
                The number of items to remove from the group beginning at
                <code>start</code>.
                Negative values are clamped to zero, and all other values are
                clamped such that
                0 &lt; <code>start</code> + <code>deleteCount</code> &le;
                length.
              </dd>
              <dt>sequence&lt;TimedTemplate&gt; newItems</dt>
              <dd>
                The items to be added at <code>start</code>.
                Each item, if it already has a parent group (including this
                group), is first removed from its parent group before being
                added to this group.
              </dd>
            </dl>
          </dd>
          <dt>
            sequence&lt;TimedTemplate&gt; splice (long start,
              unsigned long deleteCount, TimedTemplate... newItem)
          </dt>
          <dd>
            An overload of <code>splice</code> to take a variadic list of items
            rather than requiring a sequence.
            The operation is identical to <code>splice(unsigned long start,
            unsigned long deleteCount, sequence&lt;TimedTemplate&gt;
            newItems)</code>.
          </dd>
          <dt>long indexOf (TimedTemplate item)</dt>
          <dd>
            Returns the index of <code>item</code> within the group.
            If <code>item</code> is not in the group, returns <code>-1</code>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>ParGroupTemplate</code> interface</h3>
        <p>
          <a>ParGroup</a> objects can be created from <a>ParGroupTemplate</a>
          objects.
        </p>
        <dl title="[Constructor] interface ParGroupTemplate
          : AnimationGroupTemplate"
          class="idl">
        </dl>
      </section>
      <section>
        <h3>The <code>SeqGroupTemplate</code> interface</h3>
        <p>
          <a>SeqGroup</a> objects can be created from <a>SeqGroupTemplate</a>
          objects.
        </p>
        <dl title="[Constructor] interface SeqGroupTemplate
          : AnimationGroupTemplate" class="idl">
        </dl>
      </section>
      <section>
        <h3>Instantiating an <code>AnimationGroupTemplate</code></h3>
        <p class="todo">
          TBD. This is probably all wrong.
        </p>
        <p>
          The procedure for creating an <code>AnimationGroup</code> from
          an <code>AnimationGroupTemplate</code>, <var>template</var>,
          given a list of target elements, and optionally given a <var>parent
          group</var> follows.
        </p>
        <p>
          Note that <code>ParGroupTemplate</code> objects produce
          <code>ParGroup</code> objects and likewise
          <code>SeqGroupTemplate</code> objects produce <code>SeqGroup</code>
          objects.
          In the following description the <code>AnimationGroupTemplate</code>
          and <code>AnimationGroup</code> types should be substituted with the
          concrete types in use.
        </p>
        <ol>
          <li>
            Create an empty sequence to hold the generated
            <code>AnimationGroup</code> objects.
          </li>
          <li>
            For each <var>element</var> in the list of target elements:
            <ol>
              <li>
                Create a new <code>AnimationGroup</code> object,
                <var>group</var>.
              </li>
              <li>
                Set the <code>timing</code> property of <var>group</var> to
                a copy of <code>template.timing</code>.
              </li>
              <li>
                For each <var>child</var> in <var>template</var>, call
                <code><var>child</var>.animateWithParent(<var>element</var>,
                <var>group</var>, <code>startTime</code>)</code> or
                <code><var>child</var>.animateLiveWithParent(<var>element</var>,
                <var>group</var>, <code>startTime</code>)</code> depending on
                whether this procedure was invoked with <code>animate</code> or
                <code>animateLive</code>.
              </li>
              <li>
                If <var>parentGroup</var> is not specified, let
                <var>parentGroup</var> be
                <code><var>element</var>.ownerDocument.animationTimeline</code>.
              </li>
              <li>
                Append <var>group</var> to <var>parentGroup</var>.
              </li>
              <li>
                Append <var>group</var> to the sequence of
                <code>AnimationGroup</code> objects.
              </li>
            </ol>
          </li>
          <li>
            Return the sequence of <code>AnimationGroup</code> objects.
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Custom effects</h2>
      <div class="annotation">
        <p>
          I think we want two types of custom effects.
          Following is the general-purpose animate-anything kind of effect.
          The other type, which is not defined here, is the one that can
          participate in the animation sandwich just like any other.
        </p>
        <p>
          This, second, native-like animation effect, would have the
          following features:
        </p>
        <ul>
          <li>Shares the same function signature as
              <code><a>AnimationEffect</a>.sample</code></li>
          <li>Gets passed the underlying value and passes out the animated
              value.</li>
          <li>Has a target attribute and is sorted against other
              <a>AnimationEffect</a> objects (including platform
              objects)</li>
          <li>Can be added as a child of
              a <a>GroupedAnimationEffect</a>.</li>
        </ul>
        <p>
          That's a bit more difficult since you have to be careful that the
          custom effect doesn't do anything naughty while you're in the
          middle of compositing the animation sandwich.
          I think we should postpone this until Web Animations 2.
        </p>
      </div>
    </section>

    <section>
      <h2>Script interface</h2>
      <section>
        <h3>The <code>TimingFunction</code> interface</h3>
        <p>
          The <a title="timing function">timing functions</a> provided by Web
          Animations share a common <a>TimingFunction</a> interface as defined
          below.
        </p>
        <dl title="interface TimingFunction" class="idl">
          <dt>double scaleTime()</dt>
          <dd>
            <p>
              Takes an input time fraction in the range [0, 1] and applies some
              transformation on the value to produce an output time fraction.
            </p>
            <dl class="parameters">
              <dt>double time</dt> <!-- Oh yeah! -->
              <dd>
                The input time fraction.
              </dd>
              <dt>TimedItem? item</dt>
              <dd>
                <p>
                  The <a>TimedItem</a> for which the time scaling operation is
                  being performed.
                </p>
                <p>
                  Some timing functions, for example, may produce different
                  results depending on the animation values involved to produce
                  an even rate of change.
                </p>
                <p>
                  This may be <code>null</code>, for example, when invoked
                  directly by user code for the purpose of testing or re-using
                  the scaling operation in another context.
                </p>
                <p>
                  Implementations of this interface for which there is no
                  meaningful result in the absence of a <a>TimedItem</a> will
                  simply return <code>time</code> unchanged when
                  <code>item</code> is <code>null</code>.
                </p>
              </dd>
            </dl>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <var>time</var> is outside the range [0, 1].
              </dd>
            </dl>
            <p class="issue">
              Should be just clamp x values to the range [0, 1] ?
            </p>
          </dd>
          <dt>TimingFunction clone()</dt>
          <dd>
            <p>
              For implementations of this interface that have local state,
              produces an identical but independent copy of this object.
              For implementations without local state, returns the same object.
            </p>
          </dd>
          <dt>static TimingFunction? createFromString(DOMString spec)</dt>
          <dd>
            <p>
              Creates a new <a>TimingFunction</a> object based on a string-based
              specification (e.g. "ease-in").
            </p>
            <p>
              The acceptable values and their meanings are those defined for the
              <a
              href="http://www.w3.org/TR/css3-transitions/#transition-timing-function-property">transition-timing-function</a>
              property in CSS Transitions [[!CSS3-TRANSITIONS]].
            </p>
            <p>
              In addition to the values defined in CSS Transitions, this method
              extends the <code>steps()</code> function notation to allow
              &lsquo;middle&rsquo; as a transition point keyword (e.g.
              <code>steps(3, middle)</code>) corresponding to the
              &lsquo;middle&rsquo; <a>StepPosition</a> value.
              Similarly, the keyword &lsquo;steps-middle&rsquo; is recognized by
              and given the meaning <code>steps(1, middle)</code>.
            </p>
            <p>
              Strings that specify a <code>cubic-bezier()</code> timing function
              result in a new <a>CubicBezierTimingFunction</a> being returned.
              Strings that specify a <code>steps()</code> function produce a new
              <a>StepTimingFunction</a>.
            </p>
            <p>
              If <code>spec</code> is unrecognized, <code>null</code> is
              returned.
              User agents that provide debugging feedback SHOULD report the
              unrecognized value.
            </p>
            <p class="issue">
              Should we make the &lsquo;linear&rsquo; keyword return
              <code>null</code> or <code>new CubicBezierTimingFunction([0, 0, 1,
              1])</code>?<br>
              I think <code>null</code> except that this may mark it
              harder to detect error cases.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h4>The <code>CubicBezierTimingFunction</code> interface</h4>
        <p>
          <a title="cubic Bézier timing function">Cubic Bézier timing
          functions</a> are represented using the
          <code>CubicBezierTimingFunction</code> interface defined below.
        </p>
        <dl title="interface CubicBezierTimingFunction : TimingFunction"
          class="idl">
          <dt>Constructor (sequence&lt;double&gt; points)</dt>
          <dd>
            <p>
              Creates a new <a>CubicBezierTimingFunction</a> object and
              initializes the <code>points</code> member to the passed in list
              of <code>points</code>.
            </p>
            <p class="annotation">
              It would be more convenient for authors if the passed in list of
              points could be longer than four items and we simply read the
              first four items and ignored the rest.
              However, applications may begin to depend on that behavior and
              we could not easily allow this object to take longer lists (to
              represent more complex curves) in the future without adding
              a separate constructor for that purpose.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if any of the <var>x</var> values in
                <code>points</code> is outside the range [0, 1]
                or if the length of <code>points</code> is not 4 items.
              </dd>
            </dl>
          </dd>
          <dt>attribute sequence&lt;double&gt; points</dt>
          <dd>
            <p>
              A sequence of four real numbers representing the coordinates of
              the two control points in the following sequence
              <var>&lt;p1-x&gt;</var> <var>&lt;p1-y&gt;</var>
              <var>&lt;p2-x&gt;</var> <var>&lt;p2-y&gt;</var>.
            </p>
            <p>
              Each of the <var>x</var> values (i.e. <var>p1-x</var> and
              <var>p2-x</var>) must be in the range [0, 1].
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if an <var>x</var> value is outside the
                range [0, 1].
              </dd>
              <dt>DOMException of type
                  <code>InvalidModificationError</code></dt>
              <dd>
                Raised on attempting to alter the length of
                <code>points</code>.
              </dd>
            </dl>
          </dd>
          <dt>double scaleTime(double time, TimedItem? item)</dt>
          <dd>
            Applies the timing function produced by the cubic Bézier curve
            with points (0,0), (<code>points[0], points[1]</code>),
            (<code>points[2]</code>, <code>points[3]</code>), (1, 1).
          </dd>
          <dt>TimingFunction clone()</dt>
          <dd>
            Returns a copy of this object.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>StepTimingFunction</code> interface</h3>
        <p>
          <a title="step timing function">Step timing functions</a> are
          represented by the <a>StepTimingFunction</a> interface.
        </p>
        <dl title="interface StepTimingFunction : TimingFunction" class="idl">
          <dt>Constructor (unsigned integer numSteps,
                           optional StepPosition position = 'end')</dt>
          <dd>
            <p>
              Creates a new <a>StepTimingFunction</a> with the specified
              number of steps and transition point.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <code>numSteps</code> is zero.
              </dd>
            </dl>
          </dd>
          <dt>attribute unsigned integer numSteps</dt>
          <dd>
            <p>
              A number greater than or equal to one representing the number of
              steps in the function.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if the number of steps is zero.
              </dd>
            </dl>
          </dd>
          <dt>attribute StepPosition position</dt>
          <dd>
            The point within each interval at which the change in value
            occurs.
          </dd>
          <dt>double scaleTime(double time, TimedItem? item)</dt>
          <dd>
            Returns the value of applying the step function defined by
            <code>numSteps</code> and <code>position</code> with input
            <var>time</var>.
            The behavior of the step function is described in <a
            href="#timing-in-discrete-steps" class="sectionRef"></a>.
          </dd>
          <dt>TimingFunction clone()</dt>
          <dd>
            Returns a copy of this object.
          </dd>
        </dl>
        <section>
          <h4>The <code>StepPosition</code> enumeration</h4>
          <p>
            The point within a step interval at which the change in value occurs
            is specified using one of the <a>StepPosition</a> enumeration
            values.
          </p>
          <dl title="enum StepPosition" class="idl">
            <dt>start</dt>
            <dd>
              The change in value occurs at the beginning of the interval.
            </dd>
            <dt>middle</dt>
            <dd>
              The change in value occurs at the midpoint of the interval.
            </dd>
            <dt>end</dt>
            <dd>
              The change in value occurs at the end of the interval.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>The <code>KeyframeList</code> interface</h3>
        <p>
          The <a>KeyframeList</a> object is a collection of <a>Keyframe</a>
          objects sorted by the offset of each <a>Keyframe</a>.
        </p>
        <dl title="interface KeyframeList" class="idl">
          <dt>readonly attribute unsigned long length</dt>
          <dd>
            The number of frames in the list.
          </dd>
          <dt>void clear ()</dt>
          <dd>
            Removes all frames from this list.
          </dd>
          <dt>getter Keyframe? (unsigned long index)</dt>
          <dd>
            Returns the frame at <code>index</code> if it exists or
            <code>null</code> otherwise.
          </dd>
          <dt>Keyframe add((Keyframe or KeyframeDictionary) frame)</dt>
          <dd>
            <p>
              Adds <var>frame</var> to the list such that the list remains
              sorted by the offset of the frames.
            </p>
            <p>
              If <var>frame</var> is of type <a>KeyframeDictionary</a> then
              a <a>Keyframe</a> object is first constructed by calling
              <code>Keyframe(<var>frame</var>)</code> before adding the
              newly constructed <a>Keyframe</a> to the list.
            </p>
            <p>
              If there already exists a frame in this list with offset
              <code><var>frame</var>.offset</code>, the newly added
              <var>frame</var> will appear in the list <em>after</em> the
              already existing frames in the list with the same offset.
            </p>
            <p>
              If <var>frame</var> is already part of another <a>KeyframeList</a>
              it is first removed from that list before being added to this
              list.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <var>frame</var> is a <a>KeyframeDictionary</a> whose
                offset is outside the range [0,1] or missing.
              </dd>
            </dl>
          </dd>
          <dt>Keyframe? remove(unsigned long index)</dt>
          <dd>
            Removes the frame at position <var>index</var> and returns it.
            If index is outside the range [0, length), then <code>null</code> is
            returned.
          </dd>
          <dt>long indexOf(Keyframe frame)</dt>
          <dd>
            Returns the index of <var>frame</var> within the list. If
            <var>frame</var> is not a member of the list, returns
            <code>-1</code>.
          </dd>
          <dt>KeyframeList distribute()</dt>
          <dd>
            <p>
              Adjusts the offsets of the frames in the list such that the
              offsets are spaced equidistantly whilst maintaining their current
              order and such that the first frame (when there are multiple
              frames) has offset 0 and the last frame (if any) has offset 1.
            </p>
            <p>
              For <var>frame</var> at position <var>i</var> in the list where
              0 &le; <var>i</var> &lt; <code>length</code>, an offset will be
                assigned equal to <code>i / (length - 1)</code> unless
                <code>length</code> is 1 in which case it will be given offset
                1.
            </p>
            <p>
              After applying the changes, this list is returned.
            </p>
          </dd>
        </dl>
        <div class="annotation">
          <p>
            The following changes for making keyframes easier to work with in
            future have been proposed:
          </p>
          <pre class="example sh_javascript">
// Currently you have to do this
effect.frames.add({ property: 'left', offset: 0.3, value: '100px' }); 

// It would be nice if you could also do this
effect.frames.add(0.3, 'left', '100px');

// Also, fetching by offset would be good

// Returns the last frame with offset 0.3 if there is one.
// If there is none, does the interpolation and returns a new frame? 
var frame = effect.frames['0.3']; 
          </pre>
        </div>
      </section>
      <section>
        <h3>The <code>Keyframe</code> interface</h3>
        <p>
          An individual <a>key frame</a> is represented by the <a>Keyframe</a>
          interface.
        </p>
        <div class="issue">
          <p>
            Currently a <a>Keyframe</a> can only target a single property which
            is defined on the <a>KeyframeAnimationEffect</a>.
            This is different to CSS.
            Is this something we want to change?
            It would complicate the API, of course, but is it worth it?
          </p>
        </div>
        <p>
          <dl title="interface Keyframe" class="idl">
            <dt>Constructor (KeyframeDictionary dictionary)</dt>
            <dd>
              <p>
                Creates a new <a>Keyframe</a> object using the parameters
                specified in <var>dictionary</var>.
              </p>
              <p>
                <code><var>dictionary</var>.offset</code> is clamped to the
                range [0, 1] before setting.
              </p>
            </dd>
            <dt>attribute DOMString value</dt>
            <dd>
              The value to assign to the target attribute or property at the
              given offset.
            </dd>
            <dt>attribute double offset</dt>
            <dd>
              <p>
                A value between 0 and 1 inclusive representing the offset
                within the iteration duration of the animation where this value
                should appear.
              </p>
              <p>
                If this keyframe belongs to a <a>KeyframeList</a>, changes to
                this value cause the <a>KeyframeList</a> to be immediately
                re-sorted using a stable sort such that all children are ordered
                by their offset but children with identical offsets retain their
                relative position in the list.
              </p>
              <p>
                Exceptions:
              </p>
              <dl class="exceptions">
                <dt>DOMException of type <code>IndexSizeError</code></dt>
                <dd>
                  Raised on setting a value outside the range [0,1].
                </dd>
              </dl>
            </dd>
            <dt>attribute DOMString? timingFunction</dt>
            <dd>
              <p>
                An optional <a>timing function</a> to apply between this
                keyframe and the next keyframe in any <a>KeyframeList</a> in
                which this object appears.
              </p>
              <p>
                The acceptable values and the handling of unrecognized values is
                identical to the behavior described for the
                <a href="#widl-TimingDictionary-timingFunction"
                class="idlType"><code>timingFunction</code></a> member of
                <a>TimingDictionary</a>.
              </p>
            </dd>
          </dl>
        </p>
      </section>
      <section>
        <h3>The <code>KeyframeDictionary</code> dictionary</h3>
        <p>
          To simplify creation of <a>Keyframe</a> objects
          a <code>KeyframeDictionary</code> can be used.
        </p>
        <p>
          The members of the dictionary correspond to attributes in the
          <a>Keyframe</a> interface which provides a more complete description
          of their meaning and usage.
        </p>
        <dl title="dictionary KeyframeDictionary" class="idl">
          <dt>DOMString value = ""</dt>
          <dd>
            The value to assign to the target attribute or property at the given
            offset.
          </dd>
          <dt>double offset = 1</dt>
          <dd>
            A value between 0 and 1 (inclusive) representing the offset within
            the iteration duration of the animation where this value should
            appear.
          </dd>
          <dt>DOMString? timingFunction = null</dt>
          <dd>
            <p>
              A string specifying the <a>timing function</a> to apply between
              this keyframe and the next keyframe in any <a>KeyframeList</a> in
              which this object appears.
            </p>
            <p>
              The acceptable values and the handling of unrecognized values is
              identical to the behavior described for the
              <a href="#widl-TimingDictionary-timingFunction"
              class="idlType"><code>timingFunction</code></a> member of
              <a>TimingDictionary</a>.
            </p>
          </dd>
        </dl>
      </section>
    </section>

  </body>
</html>
